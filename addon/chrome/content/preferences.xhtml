<vbox xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
      xmlns:html="http://www.w3.org/1999/xhtml"
      id="zoterogptplus-prefs"
      onload="Zotero.ZoteroGPT.prefs.init()">

  <html:style>
    #zoterogptplus-prefs { padding: 12px 10px 30px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    .page-title { font-size: 18px; font-weight: 600; margin: 0 0 16px; }
    .section { margin: 0 0 20px; }
    .section-title { font-size: 14px; font-weight: 600; margin: 0 0 12px; }
    .section-subtitle { font-size: 13px; font-weight: 600; margin: 8px 0 6px; }
    .pref-row { display: flex; align-items: center; margin: 8px 0; min-height: 28px; }
    .pref-label { width: 110px; font-weight: 400; font-size: 13px; }
    .pref-input { flex: 1; height: 24px; }
    .pref-slider { flex: 1; margin: 0 12px; }
    .pref-value { width: 50px; text-align: left; font-size: 13px; }
    .pref-password-container { flex: 1; display: flex; align-items: center; position: relative; }
    .pref-password { flex: 1; height: 24px; padding-right: 24px; }
    .eye-icon { position: absolute; right: 6px; cursor: pointer; opacity: 0.6; font-size: 14px; }
    .pref-btn { margin-left: 8px; height: 24px; padding: 0 10px; font-size: 12px; }
    .pill-label {
      padding: 2px 8px;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(0, 0, 0, 0.2);
      margin-right: 10px;
      width: auto !important;
      min-width: 70px;
      text-align: center;
    }
    .icon-btn { min-width: 32px; height: 24px; margin-left: 6px; padding: 0; }
    .indent { margin-left: 20px; }
    .test-bar {
      margin: 12px 0;
      background: #fff;
      border: 1px solid #ddd;
      padding: 8px 12px;
      border-radius: 4px;
      min-height: 36px;
      display: flex;
      align-items: center;
    }
    .test-actions { margin: 8px 0 16px; }
    .config-row { margin: 12px 0 20px; border-top: 1px solid #eee; padding-top: 16px; }
    .config-label { margin-right: 10px; font-size: 13px; }
    .prompts-table { width: 100%; border-collapse: collapse; margin: 10px 0; border: 1px solid #ddd; }
    .prompts-table th, .prompts-table td {
      border: 1px solid #ddd;
      padding: 6px 10px;
      text-align: left;
      font-size: 12px;
    }
    .prompts-table th { background: #f5f5f5; font-weight: 600; }
    .prompts-table tr.selected { background: #eef6ff; }
    .prompt-actions { display: flex; justify-content: flex-end; gap: 6px; margin-top: 8px; }
    .prompts-help { margin: 4px 0 10px; font-size: 12px; opacity: 0.8; }
    .link { color: #0066cc; text-decoration: none; }
    .link:hover { text-decoration: underline; }
    .ai-outline-title { color: #d93025; margin-top: 4px; }
  </html:style>

  <label class="page-title" value="GPT Plus"/>

  <!-- General Settings -->
  <vbox class="section">
    <label class="section-title" value="General"/>

    <!-- Base API Row -->
    <hbox class="pref-row" align="center">
      <label class="pref-label pill-label" value="Base API"/>
      <textbox id="pref-api" class="pref-input" placeholder="https://api.openai.com"/>
      <menulist id="pref-api-provider" class="icon-btn">
        <menupopup>
          <menuitem label="OpenRouter" value="https://openrouter.ai/api"/>
          <menuitem label="Deepseek" value="https://api.deepseek.com"/>
          <menuitem label="SiliconFlow" value="https://api.siliconflow.cn"/>
          <menuitem label="Volcengine" value="https://ark.cn-beijing.volces.com/api"/>
          <menuitem label="Grok" value="https://api.x.ai"/>
          <menuitem label="Gemini" value="https://generativelanguage.googleapis.com"/>
          <menuitem label="Azure" value="azure"/>
          <menuitem label="Kimi" value="https://api.moonshot.cn"/>
          <menuitem label="Tongyi" value="https://dashscope.aliyuncs.com/compatible-mode"/>
          <menuitem label="Baidu" value="https://qianfan.aliyuncs.com"/>
          <menuitem label="Bigmodel" value="https://open.bigmodel.cn/api/paas"/>
          <menuitem label="OpenAI" value="https://api.openai.com"/>
          <menuitem label="ChatAnywhere" value="https://api.chatanywhere.tech"/>
          <menuitem label="Api2d" value="https://openai.api2d.net"/>
          <menuitem label="Custom" value="custom"/>
        </menupopup>
      </menulist>
    </hbox>

    <!-- API Key Row -->
    <hbox class="pref-row" align="center">
      <label class="pref-label" value="API Key"/>
      <hbox class="pref-password-container">
        <textbox id="pref-secretKey" class="pref-password" type="password" placeholder="sk-..."/>
        <html:span class="eye-icon" onclick="Zotero.ZoteroGPT.prefs.togglePassword('secretKey')">üëÅÔ∏è</html:span>
      </hbox>
      <button id="pref-secretKey-toggle" class="pref-btn" label="Click to display"
              oncommand="Zotero.ZoteroGPT.prefs.togglePassword('secretKey')"/>
    </hbox>

    <!-- Model Row -->
    <hbox class="pref-row" align="center">
      <label class="pref-label" value="Model"/>
      <textbox id="pref-model" class="pref-input" placeholder="gpt-3.5-turbo"/>
      <menulist id="pref-model-preset" class="icon-btn">
        <menupopup>
          <menuitem label="GPT-3.5" value="gpt-3.5-turbo"/>
          <menuitem label="GPT-4" value="gpt-4"/>
          <menuitem label="GPT-4o" value="gpt-4o"/>
          <menuitem label="GPT-4o-mini" value="gpt-4o-mini"/>
          <menuitem label="Claude 3.5" value="anthropic/claude-3.5-sonnet"/>
        </menupopup>
      </menulist>
    </hbox>

    <hbox class="pref-row" align="center">
      <label class="pref-label" value="Temperature"/>
      <html:input id="pref-temperature-slider" type="range" min="0" max="2" step="0.1" class="pref-slider"/>
      <label id="pref-temperature-value" class="pref-value" value="1.0"/>
    </hbox>

    <hbox class="pref-row" align="center">
      <label class="pref-label" value="Max Tokens"/>
      <html:input id="pref-maxTokens-slider" type="range" min="256" max="32000" step="256" class="pref-slider"/>
      <label id="pref-maxTokens-value" class="pref-value" value="4096"/>
    </hbox>

    <hbox class="pref-row" align="center">
      <label class="pref-label" value="Related Number"/>
      <html:input id="pref-relatedNumber-slider" type="range" min="1" max="30" step="1" class="pref-slider"/>
      <label id="pref-relatedNumber-value" class="pref-value" value="5"/>
    </hbox>

    <hbox class="pref-row" align="center">
      <label class="pref-label" value="Chat Number"/>
      <html:input id="pref-chatNumber-slider" type="range" min="0" max="20" step="1" class="pref-slider"/>
      <label id="pref-chatNumber-value" class="pref-value" value="3"/>
    </hbox>

    <hbox class="pref-row" align="center">
      <label class="pref-label" value="Extra Params"/>
      <button class="pref-btn" style="margin-left: 0;" label="Edit" oncommand="Zotero.ZoteroGPT.prefs.openTextEditor('extraParams', 'Extra Params (JSON)')"/>
    </hbox>

    <hbox class="pref-row" align="center">
      <label class="pref-label" value="System Prompt"/>
      <button class="pref-btn" style="margin-left: 0;" label="Edit" oncommand="Zotero.ZoteroGPT.prefs.openTextEditor('systemPrompt', 'System Prompt')"/>
    </hbox>

    <!-- Custom Embeddings -->
    <hbox class="pref-row" align="center" style="margin-top: 12px;">
      <checkbox id="pref-useCustomEmbeddings" label="Using custom embeddings"/>
    </hbox>

    <hbox class="pref-row indent" align="center">
      <label class="pref-label" value="Full API"/>
      <textbox id="pref-embeddingApi" class="pref-input" placeholder="http://127.0.0.1:1234/v1/embeddings"/>
      <menulist class="icon-btn">
        <menupopup>
          <menuitem label="Local" value="http://127.0.0.1:1234/v1/embeddings"/>
          <menuitem label="OpenAI" value="https://api.openai.com/v1/embeddings"/>
        </menupopup>
      </menulist>
    </hbox>

    <hbox class="pref-row indent" align="center">
      <label class="pref-label" value="Key"/>
      <hbox class="pref-password-container">
        <textbox id="pref-embeddingKey" class="pref-password" type="password" placeholder="sk-..."/>
        <html:span class="eye-icon" onclick="Zotero.ZoteroGPT.prefs.togglePassword('embeddingKey')">üëÅÔ∏è</html:span>
      </hbox>
      <button id="pref-embeddingKey-toggle" class="pref-btn" label="Click to display"
              oncommand="Zotero.ZoteroGPT.prefs.togglePassword('embeddingKey')"/>
    </hbox>

    <hbox class="pref-row indent" align="center">
      <label class="pref-label" value="Model"/>
      <textbox id="pref-embeddingModel" class="pref-input" placeholder="text-embedding-ada-002"/>
      <menulist class="icon-btn">
        <menupopup>
          <menuitem label="ada-002" value="text-embedding-ada-002"/>
          <menuitem label="3-small" value="text-embedding-3-small"/>
          <menuitem label="3-large" value="text-embedding-3-large"/>
        </menupopup>
      </menulist>
    </hbox>

    <hbox class="pref-row indent" align="center">
      <label class="pref-label" value="Batch Size"/>
      <html:input id="pref-embeddingBatchNum-slider" type="range" min="1" max="100" step="1" class="pref-slider"/>
      <label id="pref-embeddingBatchNum-value" class="pref-value" value="10"/>
    </hbox>
  </vbox>

  <!-- Test Bar -->
  <html:div class="test-bar">
    <label id="pref-test-result" value="Click test to start" style="font-size: 13px; color: #666;"/>
  </html:div>

  <hbox class="test-actions" align="center">
    <button id="pref-test-btn" class="pref-btn" style="margin-left: 0;" label="Test" oncommand="Zotero.ZoteroGPT.prefs.testConnection()"/>
    <spacer flex="1"/>
    <button class="pref-btn" label="Help" oncommand="Zotero.launchURL('https://github.com/niehu2018/zotero-gpt-plus')"/>
  </hbox>

  <!-- Config Management -->
  <hbox class="config-row" align="center">
    <button class="pref-btn" style="margin-left: 0;" label="Save Config" oncommand="Zotero.ZoteroGPT.prefs.saveConfig()"/>
    <spacer flex="1"/>
    <label class="config-label" value="Switch to Config"/>
    <menulist id="pref-config-select" style="min-width: 140px;">
      <menupopup>
        <!-- Populated by JS -->
      </menupopup>
    </menulist>
    <button class="pref-btn" label="Delete Config" oncommand="Zotero.ZoteroGPT.prefs.deleteConfig()"/>
  </hbox>

  <!-- Pro Functions -->
  <vbox class="section">
    <label class="section-title" value="Pro Functions ‚≠ê"/>
    <label class="section-subtitle ai-outline-title" value="AI Outline ‰ºòÂåñ‰∏≠ÊñáËß£Êûê"/>

    <checkbox id="pref-aiOutline" label="AI Outline"/>
    <checkbox id="pref-readerSidePanel" label="Reader Side Panel"/>
    <checkbox id="pref-noteSidePanel" label="Note Side Panel"/>
    <checkbox id="pref-popupShortcuts" label="Enable popup shortcut prompts in the reading interface"/>
    <checkbox id="pref-autoInsertAnnotation" label="GPT answer automatically inserted into the annotation comment"/>

    <hbox class="pref-row indent" align="center">
      <label class="pref-label" value="Annotation Color"/>
      <html:input id="pref-annotationColor" type="color" value="#b99bcf" style="width: 60px; height: 24px; border: 1px solid #ddd;"/>
    </hbox>

    <checkbox id="pref-altSelection" label="Enable continuous selection when press the Alt key"/>
  </vbox>

  <!-- Prompts -->
  <vbox class="section">
    <label class="section-title" value="Prompts"/>
    <label class="prompts-help">ÊúâÂÖ≥‰∏çÂêåTypeÁöÑpromptÁöÑ‰ΩúÁî®ÂüüËØ¶ËßÅ <html:a class="link" href="https://github.com/niehu2018/zotero-gpt-plus/wiki" onclick="Zotero.launchURL(this.href); return false;">‰∏≠ÊñáÊñáÊ°£</html:a>„ÄÇ</label>

    <html:div id="prompts-container">
      <html:table class="prompts-table">
        <html:thead>
          <html:tr>
            <html:th style="width: 120px;">ÂêçÁß∞</html:th>
            <html:th style="width: 120px;">Á±ªÂûã</html:th>
            <html:th>ÊèêÁ§∫ËØç</html:th>
          </html:tr>
        </html:thead>
        <html:tbody id="prompts-tbody">
          <!-- Populated by JS -->
        </html:tbody>
      </html:table>
    </html:div>

    <hbox class="prompt-actions" align="center">
      <button class="pref-btn" label="‚Üë" oncommand="Zotero.ZoteroGPT.prefs.movePrompt(-1)" tooltiptext="Move Up"/>
      <button class="pref-btn" label="‚Üì" oncommand="Zotero.ZoteroGPT.prefs.movePrompt(1)" tooltiptext="Move Down"/>
      <button class="pref-btn" label="Edit" oncommand="Zotero.ZoteroGPT.prefs.editPrompt()"/>
      <button class="pref-btn" label="Add" oncommand="Zotero.ZoteroGPT.prefs.addPrompt()"/>
    </hbox>
  </vbox>

  <!-- Other -->
  <vbox class="section">
    <label class="section-title" value="Other"/>
    <checkbox id="pref-preserveReasoningClipboard" label="Copy to clipboard to preserve reasoning content"/>
    <checkbox id="pref-preserveReasoningNote" label="Save as note to preserve reasoning content"/>
  </vbox>

  <!-- Links -->
  <vbox class="section">
    <label class="section-title" value="Links"/>
    <label class="tiny-help"><html:a class="link" href="https://github.com/niehu2018/zotero-gpt-plus/wiki" onclick="Zotero.launchURL(this.href); return false;">ËßÜÈ¢ëÊïôÁ®ã</html:a></label>
  </vbox>

</vbox>